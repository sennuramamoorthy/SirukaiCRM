version: '3.8'

services:

  # ── PostgreSQL database ────────────────────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: crm_postgres
    environment:
      POSTGRES_USER: crm
      POSTGRES_PASSWORD: crm_password
      POSTGRES_DB: crmdb
    ports:
      - "5432:5432"                   # Expose to host for local tools (pgAdmin, psql, seed script)
    volumes:
      - crm_pg_data:/var/lib/postgresql/data
    networks:
      - crm_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crm -d crmdb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ── Express API server ───────────────────────────────────────────────────────────────────────────
  server:
    build:
      context: .                      # monorepo root
      dockerfile: server/Dockerfile
    container_name: crm_server
    env_file:
      - .env.docker                   # injects PORT, JWT_SECRET, NODE_ENV, CORS_ORIGIN, DATABASE_URL
    networks:
      - crm_network
    depends_on:
      postgres:
        condition: service_healthy    # Wait for PostgreSQL to be ready
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    # Uncomment to expose the API directly for debugging (bypasses nginx):
    # ports:
    #   - "3001:3001"

  # ── React frontend + nginx reverse proxy ────────────────────────────────────────────
  client:
    build:
      context: .
      dockerfile: client/Dockerfile
    container_name: crm_client
    ports:
      - "8000:8000"                   # App accessible at http://localhost:8000
    networks:
      - crm_network
    depends_on:
      server:
        condition: service_healthy    # Wait for server healthcheck to pass before nginx starts
    restart: unless-stopped

volumes:
  crm_pg_data:
    driver: local

networks:
  crm_network:
    driver: bridge
