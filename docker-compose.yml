version: '3.8'

services:

  # ── Express API server ───────────────────────────────────────────────────────
  server:
    build:
      context: .                      # monorepo root (both Dockerfiles need access to all workspace files)
      dockerfile: server/Dockerfile
    container_name: crm_server
    env_file:
      - .env.docker                   # injects PORT, JWT_SECRET, NODE_ENV, CORS_ORIGIN
    volumes:
      # Named volume persists the SQLite database file across container restarts.
      # Path matches database.ts: path.join(__dirname, '../../data') → /app/server/data
      - crm_sqlite_data:/app/server/data
    networks:
      - crm_network
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    # Uncomment to expose the API directly for debugging (bypasses nginx):
    # ports:
    #   - "3001:3001"

  # ── React frontend + nginx reverse proxy ────────────────────────────────────
  client:
    build:
      context: .
      dockerfile: client/Dockerfile
    container_name: crm_client
    ports:
      - "80:80"                       # App accessible at http://localhost
    networks:
      - crm_network
    depends_on:
      server:
        condition: service_healthy    # Wait for server healthcheck to pass before nginx starts
    restart: unless-stopped

volumes:
  # Named volume for SQLite database persistence
  crm_sqlite_data:
    driver: local

networks:
  crm_network:
    driver: bridge
